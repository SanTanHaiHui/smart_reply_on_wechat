# 豆包API故障排查指南

## 问题：网络繁忙请稍后重试

### 可能原因及解决方案

#### 1. 域名白名单问题（最常见）

**问题**：微信小程序需要在微信公众平台配置request合法域名才能访问外部API。

**解决方案**：
1. 登录微信公众平台（https://mp.weixin.qq.com）
2. 进入：开发 -> 开发管理 -> 开发设置 -> 服务器域名
3. 在 **request合法域名** 中添加：
   ```
   https://ark.cn-beijing.volces.com
   ```
4. 保存后，重新编译小程序

**注意**：
- 开发工具中可以在"详情 -> 本地设置"中勾选"不校验合法域名"，但真机上必须配置
- 域名配置后可能需要等待几分钟生效

#### 2. 网络超时

**问题**：请求时间过长导致超时。

**解决方案**：
- 已在代码中设置超时时间为60秒
- 如果仍然超时，检查网络连接
- 可以尝试使用更快的模型（如 `doubao-seed-1-6-flash-250828`）

#### 3. API密钥错误

**问题**：API密钥配置不正确。

**检查**：
1. 确认 `doubaoApiKey` 配置正确
2. 确认API密钥未过期
3. 在控制台查看是否有"豆包API密钥未配置"的错误

#### 4. 流式响应处理问题

**问题**：微信小程序对SSE流式响应支持有限。

**解决方案**：
- 代码已自动检测并处理非流式响应
- 如果流式响应失败，会自动降级为非流式

### 调试步骤

1. **查看控制台日志**
   - 打开微信开发者工具的控制台
   - 查找以 `🔵`、`✅`、`❌` 开头的日志
   - 这些日志会显示API调用的详细过程

2. **检查错误信息**
   - 如果看到 "url not in domain list"，说明域名未配置
   - 如果看到具体的HTTP错误码，查看对应的错误信息

3. **测试API连接**
   - 在 `utils/doubao-api.js` 中已添加详细日志
   - 查看控制台输出的请求和响应信息

### 常见错误信息

| 错误信息 | 原因 | 解决方案 |
|---------|------|---------|
| url not in domain list | 域名未在白名单 | 配置request合法域名 |
| 请求超时 | 网络慢或API响应慢 | 检查网络，增加超时时间 |
| 请求失败: 401 | API密钥错误 | 检查API密钥配置 |
| 请求失败: 403 | 权限不足 | 检查API密钥权限 |
| 请求失败: 429 | 请求频率过高 | 降低请求频率 |

### 测试建议

1. **先测试非流式请求**
   - 可以临时修改代码，将 `stream: false` 测试基本连接

2. **检查网络环境**
   - 确保网络可以访问 `ark.cn-beijing.volces.com`
   - 可以使用微信开发者工具的"网络"面板查看请求详情

3. **查看完整错误信息**
   - 代码已添加详细错误日志
   - 查看控制台输出的完整错误堆栈

